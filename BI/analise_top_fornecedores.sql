DECLARE @TAB_TOP_FORN AS TABLE
(
	Q VARCHAR(10)
	,COD_FORNECEDOR INT
	,NO_FORNECEDOR VARCHAR(50)
	,VLR_VENDA NUMERIC(18,2)
)

INSERT INTO @TAB_TOP_FORN
select
	(CASE 
		WHEN CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20130101') AND CONVERT(DATE,'20130331') THEN '1Q 2013'
		WHEN CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20130401') AND CONVERT(DATE,'20130630') THEN '2Q 2013'
		WHEN CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20130701') AND CONVERT(DATE,'20130930') THEN '3Q 2013'
		WHEN CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20131001') AND CONVERT(DATE,'20131231') THEN '4Q 2013'
		WHEN CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20140101') AND CONVERT(DATE,'20140331') THEN '1Q 2014'
		WHEN CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20140401') AND CONVERT(DATE,'20140630') THEN '2Q 2014'
	END) AS Q
	,CP.COD_FORNECEDOR
	,CF.DES_FANTASIA
	,(SUM(VALOR_TOTAL)) VLR_VENDA
from 
	BI_VENDA_PRODUTO AS VP INNER JOIN BI_CAD_PRODUTO AS CP ON (VP.COD_PRODUTO = CP.COD_PRODUTO)
		INNER JOIN BI_CAD_FORNECEDOR AS CF ON (CP.COD_FORNECEDOR = CF.COD_FORNECEDOR)
WHERE 1 = 1
	AND CP.COD_FORNECEDOR in (18055) --orbis
	AND CP.COD_DEPARTAMENTO not in (6)
	AND CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20130101') AND CONVERT(DATE,'20140630')
	AND CP.COD_PRODUTO IN (SELECT DISTINCT COD_PRODUTO FROM CADASTRO_CAD_PRODUTO_METADADOS AS M WHERE M.COD_METADADO = 4 AND VLR_METADADO = 1)
GROUP BY
	(CASE 
		WHEN CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20130101') AND CONVERT(DATE,'20130331') THEN '1Q 2013'
		WHEN CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20130401') AND CONVERT(DATE,'20130630') THEN '2Q 2013'
		WHEN CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20130701') AND CONVERT(DATE,'20130930') THEN '3Q 2013'
		WHEN CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20131001') AND CONVERT(DATE,'20131231') THEN '4Q 2013'
		WHEN CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20140101') AND CONVERT(DATE,'20140331') THEN '1Q 2014'
		WHEN CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20140401') AND CONVERT(DATE,'20140630') THEN '2Q 2014'
	END)
	,CP.COD_FORNECEDOR
	,CF.DES_FANTASIA

INSERT INTO @TAB_TOP_FORN
select
	(CASE 
		WHEN CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20130101') AND CONVERT(DATE,'20130331') THEN '1Q 2013'
		WHEN CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20130401') AND CONVERT(DATE,'20130630') THEN '2Q 2013'
		WHEN CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20130701') AND CONVERT(DATE,'20130930') THEN '3Q 2013'
		WHEN CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20131001') AND CONVERT(DATE,'20131231') THEN '4Q 2013'
		WHEN CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20140101') AND CONVERT(DATE,'20140331') THEN '1Q 2014'
		WHEN CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20140401') AND CONVERT(DATE,'20140630') THEN '2Q 2014'
	END) AS Q
	,CP.COD_FORNECEDOR
	,CF.DES_FANTASIA
	,(SUM(VALOR_TOTAL)) VLR_VENDA
from 
	BI_VENDA_PRODUTO AS VP INNER JOIN BI_CAD_PRODUTO AS CP ON (VP.COD_PRODUTO = CP.COD_PRODUTO)
		INNER JOIN BI_CAD_FORNECEDOR AS CF ON (CP.COD_FORNECEDOR = CF.COD_FORNECEDOR)
WHERE 1 = 1
	AND CP.COD_FORNECEDOR in (16384) --virtus	
	AND CP.COD_DEPARTAMENTO not in (6,16)
	AND CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20130101') AND CONVERT(DATE,'20140630')
	AND CP.COD_PRODUTO IN (SELECT DISTINCT COD_PRODUTO FROM CADASTRO_CAD_PRODUTO_METADADOS AS M WHERE M.COD_METADADO = 18 AND VLR_METADADO = 1)
GROUP BY
	(CASE 
		WHEN CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20130101') AND CONVERT(DATE,'20130331') THEN '1Q 2013'
		WHEN CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20130401') AND CONVERT(DATE,'20130630') THEN '2Q 2013'
		WHEN CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20130701') AND CONVERT(DATE,'20130930') THEN '3Q 2013'
		WHEN CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20131001') AND CONVERT(DATE,'20131231') THEN '4Q 2013'
		WHEN CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20140101') AND CONVERT(DATE,'20140331') THEN '1Q 2014'
		WHEN CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20140401') AND CONVERT(DATE,'20140630') THEN '2Q 2014'
	END)
	,CP.COD_FORNECEDOR
	,CF.DES_FANTASIA

INSERT INTO @TAB_TOP_FORN
select TOP 19
	'1Q 2013'
	,CP.COD_FORNECEDOR
	,CF.DES_FANTASIA
	,(SUM(VALOR_TOTAL)) VLR_VENDA
from 
	BI_VENDA_PRODUTO AS VP INNER JOIN BI_CAD_PRODUTO AS CP ON (VP.COD_PRODUTO = CP.COD_PRODUTO)
		INNER JOIN BI_CAD_FORNECEDOR AS CF ON (CP.COD_FORNECEDOR = CF.COD_FORNECEDOR)
WHERE 1 = 1
	AND CP.COD_FORNECEDOR NOT in (18055,16384)
	AND CP.COD_DEPARTAMENTO not in (6)
	AND CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20130101') AND CONVERT(DATE,'20130331')
GROUP BY
	CP.COD_FORNECEDOR
	,CF.DES_FANTASIA
ORDER BY
	SUM(VALOR_TOTAL) DESC
	
INSERT INTO @TAB_TOP_FORN
select TOP 19
	'2Q 2013'
	,CP.COD_FORNECEDOR
	,CF.DES_FANTASIA
	,(SUM(VALOR_TOTAL)) VLR_VENDA
from 
	BI_VENDA_PRODUTO AS VP INNER JOIN BI_CAD_PRODUTO AS CP ON (VP.COD_PRODUTO = CP.COD_PRODUTO)
		INNER JOIN BI_CAD_FORNECEDOR AS CF ON (CP.COD_FORNECEDOR = CF.COD_FORNECEDOR)
WHERE 1 = 1
	AND CP.COD_FORNECEDOR NOT in (18055,16384)
	AND CP.COD_DEPARTAMENTO not in (6)
	AND CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20130401') AND CONVERT(DATE,'20130630')
GROUP BY
	CP.COD_FORNECEDOR
	,CF.DES_FANTASIA
ORDER BY
	SUM(VALOR_TOTAL) DESC
	
INSERT INTO @TAB_TOP_FORN
select TOP 19
	'3Q 2013'
	,CP.COD_FORNECEDOR
	,CF.DES_FANTASIA
	,(SUM(VALOR_TOTAL)) VLR_VENDA
from 
	BI_VENDA_PRODUTO AS VP INNER JOIN BI_CAD_PRODUTO AS CP ON (VP.COD_PRODUTO = CP.COD_PRODUTO)
		INNER JOIN BI_CAD_FORNECEDOR AS CF ON (CP.COD_FORNECEDOR = CF.COD_FORNECEDOR)
WHERE 1 = 1
	AND CP.COD_FORNECEDOR NOT in (18055,16384)
	AND CP.COD_DEPARTAMENTO not in (6)
	AND CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20130701') AND CONVERT(DATE,'20130930')
GROUP BY
	CP.COD_FORNECEDOR
	,CF.DES_FANTASIA
ORDER BY
	SUM(VALOR_TOTAL) DESC
	
INSERT INTO @TAB_TOP_FORN
select TOP 19
	'4Q 2013'
	,CP.COD_FORNECEDOR
	,CF.DES_FANTASIA
	,(SUM(VALOR_TOTAL)) VLR_VENDA
from 
	BI_VENDA_PRODUTO AS VP INNER JOIN BI_CAD_PRODUTO AS CP ON (VP.COD_PRODUTO = CP.COD_PRODUTO)
		INNER JOIN BI_CAD_FORNECEDOR AS CF ON (CP.COD_FORNECEDOR = CF.COD_FORNECEDOR)
WHERE 1 = 1
	AND CP.COD_FORNECEDOR NOT in (18055,16384)
	AND CP.COD_DEPARTAMENTO not in (6)
	AND CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20131001') AND CONVERT(DATE,'20131231')
GROUP BY
	CP.COD_FORNECEDOR
	,CF.DES_FANTASIA
ORDER BY
	SUM(VALOR_TOTAL) DESC
	
INSERT INTO @TAB_TOP_FORN
select TOP 19
	'1Q 2014'
	,CP.COD_FORNECEDOR
	,CF.DES_FANTASIA
	,(SUM(VALOR_TOTAL)) VLR_VENDA
from 
	BI_VENDA_PRODUTO AS VP INNER JOIN BI_CAD_PRODUTO AS CP ON (VP.COD_PRODUTO = CP.COD_PRODUTO)
		INNER JOIN BI_CAD_FORNECEDOR AS CF ON (CP.COD_FORNECEDOR = CF.COD_FORNECEDOR)
WHERE 1 = 1
	AND CP.COD_FORNECEDOR NOT in (18055,16384)
	AND CP.COD_DEPARTAMENTO not in (6)
	AND CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20140101') AND CONVERT(DATE,'20140331')
GROUP BY
	CP.COD_FORNECEDOR
	,CF.DES_FANTASIA
ORDER BY
	SUM(VALOR_TOTAL) DESC

INSERT INTO @TAB_TOP_FORN
select TOP 19
	'2Q 2014'
	,CP.COD_FORNECEDOR
	,CF.DES_FANTASIA
	,(SUM(VALOR_TOTAL)) VLR_VENDA
from 
	BI_VENDA_PRODUTO AS VP INNER JOIN BI_CAD_PRODUTO AS CP ON (VP.COD_PRODUTO = CP.COD_PRODUTO)
		INNER JOIN BI_CAD_FORNECEDOR AS CF ON (CP.COD_FORNECEDOR = CF.COD_FORNECEDOR)
WHERE 1 = 1
	AND CP.COD_FORNECEDOR NOT in (18055,16384)
	AND CP.COD_DEPARTAMENTO not in (6)
	AND CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20140401') AND CONVERT(DATE,'20140630')
GROUP BY
	CP.COD_FORNECEDOR
	,CF.DES_FANTASIA
ORDER BY
	SUM(VALOR_TOTAL) DESC


SELECT
	Q
	,NO_FORNECEDOR
	,dbo.fn_FormataVlr_Excel(VLR_VENDA) AS VENDA
FROM
	@TAB_TOP_FORN
ORDER BY
	Q
	,VLR_VENDA DESC
	
	
	