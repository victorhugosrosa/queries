DECLARE @TAB_VENDA AS TABLE
(
	Q VARCHAR(15)
	,COD_PRODUTO INT
	,VLR_VENDA NUMERIC(18,2)
	,QTD_VENDA NUMERIC(18,2)
)

INSERT INTO @TAB_VENDA
SELECT
	(CASE 
		WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20120701') AND CONVERT(DATE,'20120930') THEN 'P1 - 3Q 2012'
		WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20121001') AND CONVERT(DATE,'20121231') THEN 'P2 - 4Q 2012'		
		WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20130101') AND CONVERT(DATE,'20130331') THEN 'P3 - 1Q 2013'
		WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20130401') AND CONVERT(DATE,'20130630') THEN 'P4 - 2Q 2013'
		WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20130701') AND CONVERT(DATE,'20130930') THEN 'P5 - 3Q 2013'
		WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20131001') AND CONVERT(DATE,'20131231') THEN 'P6 - 4Q 2013'
		WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20140101') AND CONVERT(DATE,'20140331') THEN 'P7 - 1Q 2014'
		WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20140401') AND CONVERT(DATE,'20140630') THEN 'P8 - 2Q 2014'
		WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20140701') AND CONVERT(DATE,'20140930') THEN 'P9 - 3Q 2014'
	END) AS Q
	,CP.COD_PRODUTO
	,SUM(VALOR_TOTAL)
	,SUM(QTDE_PRODUTO)
FROM 
	BI_VENDA_PRODUTO AS VP INNER JOIN BI_CAD_PRODUTO AS CP ON (VP.COD_PRODUTO = CP.COD_PRODUTO)
WHERE 1=1
	AND CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20120701') AND CONVERT(DATE,'20140930')
	AND VP.COD_LOJA <> 7
	AND VP.COD_PRODUTO IN (552417,552424,552134,13031,553179,994151,552462,89661,994152,552196,748414,1001606,748407,552387,994154,552578,994155,748421,999705,552356,552400,538909,552271,538947,748438,27526,1007850,27533,995474,552080,991087,517324,552455,999654,998788,44981,1007849,999653,378093,552325,27199,554657,552240,552509,998455,1001605,994153,994157,554619,517362,995473,994158,994383,341110,993273,552097,554640,994384,553162,27496,993270,993339,552448,554633,552066,998453,541664,336796,1004227,552622,1002051,552349,1002058,63173,541671,15400,994145,993268,998449,993269,999699,541688,998446,998452,552332,999698,593410,992261,993278,1004225,1002059,993272,994386,1001724,341196,994149,999701,993340,378109,999700,1004226,552257,336840,40884,593472,993280,24099,994385,552042,505529,435185,994156,998454,1002094,993279,336789,1001710,22026,1001714,552073,998451,456524,456500,552639,993282,22071,554626,993341,63197,1009635,993281,1001711,1001607,553322,995151,999628,1002060,993267,1002093,336772,993274,998450,1000477,999801,992248,552363,336826,24211,2486,991086,993271,552059,336864,750882,505567,593458,1014098,993277,554602,750813,1008689,992252,1000905,995148,995145,79310,1001712,750790,998447,999655,995147,456531,39512,1002095,994146,1001931,992479,1014100,1002096,750820,1004041,1001471,995467,994147,993276,994148,993275,429290,1008687,994150,429351,513166,1001472,995469,593434,1001933,995471,1002330,1000794,992478,1000796,547123,995150,1004040,1009272,1000795,995146,1001935,1001934,750837,1014101,993186,1008688,429320,1001932,750844,513173,1009286,992908,992906,1004017,1008788,81658,998448,594370,594387,1013373,1013374,1013372,594394,1013375,1014576,995572,995573,995574,1014102,1014103,1014508,1014593,39468,40297,97628,20251,92876,5227,78139,40716,90483,18777,28318,40723,40730,40747,40761,40785,40792,5012,956,40839,26703,86448,72724,98168,79143,66662,70072,23627,91329,4695,2493,1595,98601,15172,2585,89678,72304,89692,25638,23580,2523,7528,14878,97833,5951,76883,9294,69984,97819,69991,2578,24655,17,28349,11662,48491,28332,11679,86431,18647,192,40990,80279,1151,40891,40976,40983,41003,78146,18821,1014256,1014257,1014255,1014258,88992,26895,32896,37891,48897,65894,71895)
GROUP BY
	(CASE 
		WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20120701') AND CONVERT(DATE,'20120930') THEN 'P1 - 3Q 2012'
		WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20121001') AND CONVERT(DATE,'20121231') THEN 'P2 - 4Q 2012'		
		WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20130101') AND CONVERT(DATE,'20130331') THEN 'P3 - 1Q 2013'
		WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20130401') AND CONVERT(DATE,'20130630') THEN 'P4 - 2Q 2013'
		WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20130701') AND CONVERT(DATE,'20130930') THEN 'P5 - 3Q 2013'
		WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20131001') AND CONVERT(DATE,'20131231') THEN 'P6 - 4Q 2013'
		WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20140101') AND CONVERT(DATE,'20140331') THEN 'P7 - 1Q 2014'
		WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20140401') AND CONVERT(DATE,'20140630') THEN 'P8 - 2Q 2014'
		WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20140701') AND CONVERT(DATE,'20140930') THEN 'P9 - 3Q 2014'
	END)
	,CP.COD_PRODUTO
SELECT
	CP.COD_PRODUTO
	,CP.DESCRICAO
	,CP.NO_DEPARTAMENTO
	,CP.NO_SECAO
	,CP.NO_GRUPO
	,CP.CLASSIF_PRODUTO
	,PM.VLR_METADADO
	,V.Q
	,bi.dbo.fn_FormataVlr_Excel(V.VLR_VENDA) AS VLR_VENDA
	,bi.dbo.fn_FormataVlr_Excel(V.QTD_VENDA) AS QTD_VENDA
FROM
	BI.DBO.BI_CAD_PRODUTO AS CP
	INNER JOIN @TAB_VENDA AS V
		ON 1=1
		AND CP.COD_PRODUTO = V.COD_PRODUTO
	LEFT JOIN BI.dbo.CADASTRO_CAD_PRODUTO_METADADOS AS PM
		ON 1=1
		AND CP.COD_PRODUTO = PM.COD_PRODUTO
		AND PM.COD_METADADO = 6
WHERE 1=1
ORDER BY
	CP.COD_PRODUTO
	,V.Q