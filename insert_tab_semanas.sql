SET NOCOUNT ON
DECLARE @DATA_INI AS DATE = '20120102'
DECLARE @DATA_FIM AS DATE = '20301229'

TRUNCATE TABLE BI.DBO.BI_CAD_SEMANA

WHILE @DATA_INI <= @DATA_FIM
BEGIN
	INSERT INTO BI.DBO.BI_CAD_SEMANA
	(
		DATA
		,ANO_454
		,SEMANA_454
	)
	SELECT
		@DATA_INI
		,LEFT(dbo.ISO_WEEK(@DATA_INI),4) as ANO_454
		,BI.DBO.F_ISO_WEEK_OF_YEAR(@DATA_INI) as SEMANA_454

	SET @DATA_INI = DATEADD(D,1,@DATA_INI)
END

UPDATE BI.DBO.BI_CAD_SEMANA
SET
MES_454 = 
	(CASE
		WHEN SEMANA_454 in (1,2,3,4) THEN 1
		WHEN SEMANA_454 in (5,6,7,8,9) THEN 2
		WHEN SEMANA_454 in (10,11,12,13) THEN 3
		WHEN SEMANA_454 in (14,15,16,17) THEN 4
		WHEN SEMANA_454 in (18,19,20,21,22) THEN 5
		WHEN SEMANA_454 in (23,24,25,26) THEN 6
		WHEN SEMANA_454 in (27,28,29,30) THEN 7
		WHEN SEMANA_454 in (31,32,33,34,35) THEN 8
		WHEN SEMANA_454 in (36,37,38,39) THEN 9
		WHEN SEMANA_454 in (40,41,42,43) THEN 10
		WHEN SEMANA_454 in (44,45,46,47,48) THEN 11
		WHEN SEMANA_454 in (49,50,51,52,53) THEN 12
	END)
,NO_MES_454 = 
	(CASE
		WHEN SEMANA_454 in (1,2,3,4) THEN 'Jan 4s'
		WHEN SEMANA_454 in (5,6,7,8,9) THEN 'Fev 5s'
		WHEN SEMANA_454 in (10,11,12,13) THEN 'Mar 4s'
		WHEN SEMANA_454 in (14,15,16,17) THEN 'Abr 4s'
		WHEN SEMANA_454 in (18,19,20,21,22) THEN 'Mai 5s'
		WHEN SEMANA_454 in (23,24,25,26) THEN 'Jun 4s'
		WHEN SEMANA_454 in (27,28,29,30) THEN 'Jul 4s'
		WHEN SEMANA_454 in (31,32,33,34,35) THEN 'Ago 5s'
		WHEN SEMANA_454 in (36,37,38,39) THEN 'Set 4s'
		WHEN SEMANA_454 in (40,41,42,43) THEN 'Out 4s'
		WHEN SEMANA_454 in (44,45,46,47,48) THEN 'Nov 5s'
		WHEN SEMANA_454 in (49,50,51,52,53) THEN 'Dez 4s'
	END)

SELECT * FROM BI.DBO.BI_CAD_SEMANA



