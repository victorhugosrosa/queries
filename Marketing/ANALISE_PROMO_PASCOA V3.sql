/*
	BI.DBO.FN_FORMATAVLR_EXCEL(
	SELECT * FROM ZAN_M38 WHERE M38_val_usado IS NOT NULL

	select M38_val_usado, * from Zan_M38 where M00AF >= '2016-03-27'

	select M03DF, M03BZ,M03CH, M03CH02,M03CH03,M03CH04, M03CH05, * from Zan_M03 where M00AF >= '2016-03-27' and M03BB = '15162976873' order by M00AF

	select M03AM, M03DF, M03BZ,M03CH, M03CH02,M03CH03,M03CH04, M03CH05, * from Zan_M03 where 1=1 and M03BB = '15162976873' and M00AF >=  '2016-03-27' --and M00AF between '2016-03-17' and '2016-03-27'
*/

DECLARE @TAB_POSSIVEIS_CUPONS AS TABLE
(
	DATA DATE
	,COD_LOJA INT 
	,PDV INT
	,CUPOM INT
	,CPF VARCHAR(20)
	,VLR_CUPOM NUMERIC(18,2)
	,VLR_DESCONTO NUMERIC(18,2)
	,CUPOM_JA_USADO INT
)

INSERT INTO @TAB_POSSIVEIS_CUPONS
	select
		Z.M00AF
		,Z.M00ZA
		,Z.M00AC 
		,Z.M00AD
		,Z.M03BB
		,SUM(M03AP) AS VLR_CUPOM
		,SUM(CASE WHEN M03DF = 9927 THEN M03AQ ELSE 0 END) AS VLR_DESCONTO
		,0
	from
		Zan_M03 AS Z
		inner join
		(
		select DISTINCT
			M00AF
			,M00ZA
			,M00AC 
			,M00AD
		from
			Zan_M03
		where 1=1
			AND M03DF = 9927
			and convert(date,M00AF) between convert(date,'2016-03-17') and convert(date,'2016-04-11')
		) as tab_cupom
		on 1=1
		AND Z.M00AF = tab_cupom.M00AF
		AND Z.M00ZA = tab_cupom.M00ZA
		AND Z.M00AC = tab_cupom.M00AC
		AND Z.M00AD = tab_cupom.M00AD
	where 1=1
		--AND M03DF = 9927
		and convert(date,Z.M00AF) between convert(date,'2016-03-17') and convert(date,'2016-04-11')
	GROUP BY
		Z.M00AF
		,Z.M00ZA
		,Z.M00AC
		,Z.M00AD
		,Z.M03BB


DECLARE @TAB_CUPONS_CAMPANHA AS TABLE
(
	DATA DATE
	,COD_LOJA INT 
	,HORA INT
	,PDV INT
	,CUPOM INT
	,CPF VARCHAR(20)
	,VLR_CUPOM NUMERIC(18,2)
	,VLR_DESCONTO NUMERIC(18,2)
	,VLR_DESCONTO_USADO NUMERIC(18,2)
	,NO_CLIENTE VARCHAR(50)
	,DATA_CADASTRO DATE
	,DESC_USADO_TOTAL INT
)

INSERT INTO @TAB_CUPONS_CAMPANHA
	SELECT	
		CONVERT(DATE,M38.M00AF) AS DATA
		,M38.M00ZA AS COD_LOJA
		,M01.M01AI AS HORA
		,M38.M00AC AS PDV
		,M38.M00AD AS CUPOM	
		,M38.M38AP AS CPF
		,M01.M01AK AS Venda
		,M38AY AS VLR_DESC_TOTAL
		,M38_VAL_USADO AS VLR_DESC_USADO	
		,TC.des_cliente AS CLIENTE
		,CONVERT(DATE,TC.dta_cadastro) AS DATA_CADASTRO		
		,0
	FROM
		ZAN_M38 M38
		INNER JOIN Zan_M01 AS M01
			ON 1=1
			AND M38.M00AF = M01.M00AF
			AND M38.M00ZA = M01.M00ZA
			AND M38.M00AC = M01.M00AC
			AND M38.M00AD = M01.M00AD	
		INNER JOIN TAB_LOJA TL
		  ON TL.COD_LOJA = M38.M00ZA
		INNER JOIN TAB_CLIENTE TC
		  --ON TC.NUM_CGC = RIGHT('00000000000'+M38.M38AP,11)
		  ON TC.COD_CLIENTE = M38.M38AP
		LEFT JOIN BI.dbo.BI_CAD_LOJA2 AS L
			ON M38.M00ZA = L.COD_LOJA
	WHERE 1=1
		AND M38.M00AF between '2016-03-17' and '2016-03-27'
		--AND M01.M01AI BETWEEN 700 AND 1800
	ORDER BY
		M38.M00ZA
		,M01.M01AI

--SELECT * FROM @TAB_POSSIVEIS_CUPONS
--SELECT * FROM @TAB_CUPONS_CAMPANHA

UPDATE CC
SET
	CC.DESC_USADO_TOTAL = 1
FROM
	@TAB_CUPONS_CAMPANHA AS CC
	INNER JOIN @TAB_POSSIVEIS_CUPONS AS PC
		ON 1=1
		AND CC.CPF = PC.CPF
		AND CC.VLR_DESCONTO_USADO = PC.VLR_DESCONTO


UPDATE PC
SET
	PC.CUPOM_JA_USADO = 1
FROM
	@TAB_CUPONS_CAMPANHA AS CC
	INNER JOIN @TAB_POSSIVEIS_CUPONS AS PC
		ON 1=1
		AND CC.CPF = PC.CPF
		AND CC.VLR_DESCONTO_USADO = PC.VLR_DESCONTO		

SELECT
	-- ----------------------------------------------------------------------------------------
	CC.DATA
	,CC.COD_LOJA
	,CC.PDV
	,CC.CUPOM
	,CC.CPF
	,BI.DBO.FN_FORMATAVLR_EXCEL(CC.VLR_CUPOM) AS VLR_CUPOM
	,BI.DBO.FN_FORMATAVLR_EXCEL(CC.VLR_DESCONTO) AS VLR_DESCONTO
	,BI.DBO.FN_FORMATAVLR_EXCEL(CC.VLR_DESCONTO_USADO) AS VLR_DESCONTO_USADO	
	-- ----------------------------------------------------------------------------------------
	,PC.DATA as DATA_COMPRA_DO_DESCONTO
	,PC.COD_LOJA AS COD_LOJA_COMPRA_DO_DESCONTO
	,PC.PDV AS PDV_COMPRA_DO_DESCONTO
	,PC.CUPOM AS CUPOM_COMPRA_DO_DESCONTO
	,BI.DBO.FN_FORMATAVLR_EXCEL(PC.VLR_CUPOM) AS VLR_CUPOM_COMPRA_DO_DESCONTO
	,BI.DBO.FN_FORMATAVLR_EXCEL(PC.VLR_DESCONTO) as VLR_DESCONTO_COMPRA_DO_DESCONTO
	-- ----------------------------------------------------------------------------------------
	,CC.DESC_USADO_TOTAL
	,PC.CUPOM_JA_USADO
FROM
	@TAB_CUPONS_CAMPANHA AS CC
	INNER JOIN @TAB_POSSIVEIS_CUPONS AS PC
		ON 1=1
		AND CC.CPF = PC.CPF
		AND CC.VLR_DESCONTO_USADO = PC.VLR_DESCONTO
WHERE 1=1
	AND CC.CPF = '26904153806'--'7933287727'
ORDER BY
	CC.DATA
	,CC.COD_LOJA
	,CC.PDV
	,CC.CUPOM
	,CC.CPF
	,PC.DATA
	,PC.COD_LOJA
	,PC.PDV
	,PC.CUPOM
	,PC.CPF



SELECT
	-- ----------------------------------------------------------------------------------------
	CC.DATA
	,CC.COD_LOJA
	,CC.PDV
	,CC.CUPOM
	,CC.CPF
	,BI.DBO.FN_FORMATAVLR_EXCEL(CC.VLR_CUPOM) AS VLR_CUPOM
	,BI.DBO.FN_FORMATAVLR_EXCEL(CC.VLR_DESCONTO) AS VLR_DESCONTO
	,BI.DBO.FN_FORMATAVLR_EXCEL(CC.VLR_DESCONTO_USADO) AS VLR_DESCONTO_USADO	
	-- ----------------------------------------------------------------------------------------
	,PC.DATA as DATA_COMPRA_DO_DESCONTO
	,PC.COD_LOJA AS COD_LOJA_COMPRA_DO_DESCONTO
	,PC.PDV AS PDV_COMPRA_DO_DESCONTO
	,PC.CUPOM AS CUPOM_COMPRA_DO_DESCONTO
	,BI.DBO.FN_FORMATAVLR_EXCEL(PC.VLR_CUPOM) AS VLR_CUPOM_COMPRA_DO_DESCONTO
	,BI.DBO.FN_FORMATAVLR_EXCEL(PC.VLR_DESCONTO) as VLR_DESCONTO_COMPRA_DO_DESCONTO
	-- ----------------------------------------------------------------------------------------
	,CC.DESC_USADO_TOTAL
	,PC.CUPOM_JA_USADO
FROM
	@TAB_CUPONS_CAMPANHA AS CC
	LEFT JOIN @TAB_POSSIVEIS_CUPONS AS PC
		ON 1=1
		AND CC.CPF = PC.CPF
		AND (PC.VLR_DESCONTO <> CC.VLR_DESCONTO)
		AND PC.CUPOM_JA_USADO = 0
WHERE 1=1
	AND CC.CPF = '26904153806'--'7933287727'
	AND CC.DESC_USADO_TOTAL = 0	
	AND CC.VLR_DESCONTO_USADO IS NOT NULL
ORDER BY
	CC.DATA
	,CC.COD_LOJA
	,CC.PDV
	,CC.CUPOM
	,CC.CPF
	,PC.DATA
	,PC.COD_LOJA
	,PC.PDV
	,PC.CUPOM
	,PC.CPF



--SELECT M03DF, * FROM Zan_M03 WHERE M03BB = '26904153806' AND M00AF >= '2016-03-17' 


SELECT	
	CONVERT(DATE,M38.M00AF) AS DATA
	,M38.M00ZA AS COD_LOJA
	,M01.M01AI AS HORA
	,M38.M00AC AS PDV
	,M38.M00AD AS CUPOM	
	,M38.M38AP AS CPF
	,M01.M01AK AS Venda
	,M38AY AS VLR_DESC_TOTAL
	,M38_VAL_USADO AS VLR_DESC_USADO	
	,TC.des_cliente AS CLIENTE
	,CONVERT(DATE,TC.dta_cadastro) AS DATA_CADASTRO		
	,0
FROM
	ZAN_M38 M38
	INNER JOIN Zan_M01 AS M01
		ON 1=1
		AND M38.M00AF = M01.M00AF
		AND M38.M00ZA = M01.M00ZA
		AND M38.M00AC = M01.M00AC
		AND M38.M00AD = M01.M00AD	
	INNER JOIN TAB_LOJA TL
	  ON TL.COD_LOJA = M38.M00ZA
	INNER JOIN TAB_CLIENTE TC
	  --ON TC.NUM_CGC = RIGHT('00000000000'+M38.M38AP,11)
	  ON TC.COD_CLIENTE = M38.M38AP
	LEFT JOIN BI.dbo.BI_CAD_LOJA2 AS L
		ON M38.M00ZA = L.COD_LOJA
WHERE 1=1
	AND M38.M00AF between '2016-03-17' and '2016-03-27'
	and M38.M38AP = '26904153806'
	--AND M01.M01AI BETWEEN 700 AND 1800


select DISTINCT
	M00AF
	,M00ZA
	,M00AC 
	,M00AD
from
	Zan_M03
where 1=1
	AND M03DF = 9927
	and convert(date,M00AF) between convert(date,'2016-03-17') and convert(date,'2016-04-11') 
	and M03BB = '26904153806'
