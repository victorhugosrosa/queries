DECLARE @dataIni AS DATE = CONVERT(DATE,'20130101')
DECLARE @dataFim AS DATE = CONVERT(DATE,'20140101')

-- -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- MARGEM
-- -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	DECLARE @TAB_MARGEM AS TABLE
	(
		COD_PRODUTO INT
		,MARGEM_REAL NUMERIC(10,3)
	)
	
	INSERT INTO @TAB_MARGEM	
	SELECT
		COD_PRODUTO
		,(Sum(VLR_VENDA_BRUTA)-sum(VLR_CMV)-sum(VLR_PISCOFINS)-sum(VLR_ICMS_SAIDA*VLR_VENDA_BRUTA)) / SUM(VLR_VENDA_BRUTA) AS MARGEM_REAL
	FROM
	(
		SELECT
			s.COD_LOJA,
			DATEPART(year,s.DTA_SAIDA) as ANO,
			DATEPART(month,s.DTA_SAIDA) as MES,
			p.COD_PRODUTO AS COD_PRODUTO,
			--p.COD_SECAO AS COD_SECAO, 
			--p.COD_GRUPO AS COD_GRUPO, 
			p.FLG_NAO_PIS_COFINS AS PISCOFINS,
			l.[COD_TRIBUTACAO],
			l.[VAL_MARGEM]/100 as MARGEM_REF,
			CASE WHEN tri.TIPO_TRIBUTACAO <=2 THEN tri.val_icms*(1-val_reducao_base_calculo/100)/100 ELSE 0 END as VLR_ICMS_SAIDA,
			--tri.TIPO_TRIBUTACAO AS TIPOTRIB, 
			SUM(s.QTD_TOTAL_PRODUTO) AS QTD_SAIDA, 
			SUM(s.VAL_TOTAL_PRODUTO) AS VLR_VENDA_BRUTA, 
			SUM(s.QTD_TOTAL_PRODUTO * s.VAL_CUSTO_REP) AS VLR_CUSTO_REP, 
			--SUM(s.QTD_TOTAL_PRODUTO * s.VAL_CUSTO_MEDIO) AS VENDA_MEDIO, 
			SUM(s.QTD_TOTAL_PRODUTO * s.VAL_PMZ) AS VLR_VENDA_PMZ, 
			SUM(s.QTD_TOTAL_PRODUTO * s.VAL_CUSTO_SICMS) AS VLR_CMV, 
			SUM(s.VAL_DEB_ICMS) AS VLR_ICMS,
			--SUM(s.VAL_TOTAL_PRODUTO - s.VAL_DEB_ICMS) AS VLR_VENDA_SICMS 
			SUM(CASE WHEN p.FLG_NAO_PIS_COFINS = 'N' THEN s.VAL_TOTAL_PRODUTO *(prm.VAL_PIS/100+prm.VAL_COFINS/100) ELSE 0 END) AS VLR_PISCOFINS,
			SUM(CASE WHEN p.FLG_NAO_PIS_COFINS = 'N' THEN (s.VAL_TOTAL_PRODUTO -s.QTD_TOTAL_PRODUTO * s.VAL_CUSTO_SICMS)*(prm.VAL_PIS/100+prm.VAL_COFINS/100) ELSE 0 END) AS VLR_PISCOFINS_NET
		FROM 
		   [192.168.0.6].zeus_rtg.dbo.TAB_PRODUTO as p
		   INNER JOIN [192.168.0.6].zeus_rtg.dbo.TAB_PRODUTO_SAIDA as s with (NOLOCK) 
			ON(p.COD_PRODUTO = s.COD_PRODUTO) 
		   INNER JOIN [192.168.0.6].zeus_rtg.dbo.TAB_PRODUTO_LOJA as l with (NOLOCK) 
			ON(s.COD_LOJA = l.COD_LOJA) AND (s.COD_PRODUTO = l.COD_PRODUTO) 
		   INNER JOIN [192.168.0.6].zeus_rtg.dbo.TAB_PARAMETRO_LOJA as prm with (NOLOCK) 
			ON(l.COD_LOJA = prm.COD_LOJA) 
		   INNER JOIN [192.168.0.6].zeus_rtg.dbo.TAB_TRIBUTACAO as tri with (NOLOCK) 
			ON(l.COD_TRIBUTACAO = tri.COD_TRIBUTACAO) 
		WHERE 1=1
			and s.cod_loja not in (7)
			AND p.FLG_GRADE_PRODUTO = 'N' 
			AND P.COD_PRODUTO IN
				(27199,27496,27526,27533,27786,517324,517362,517331,993263,993262,993265,993264,993266,999698,999705,999701,999699
				,999700,994155,994153,994154,994158,994156,994157,994152,994151,748407,748421,748414,748438,44981, 993268 , 993270
				, 993272 ,993267, 993271, 993269 ,993273,993274,53822,21821,10832,10603,7245,4855,4725,8495,994146,994150,994149
				,994148,994145,994147,998446,998447,998448,998449,998450,998451,998452,998453,998454,998455,998456,998788,1001472
				,1001471,994149,994145,89661,1001931,1001932,1001933,89661,1004041,1004040,1004017,1001040,341110,593410,593472
				,750882,435185,593434,341196,750813,750790,593458,750844,750820,750837,594394,594387,594370,993277,993275,993278
				,993276,993279,993280,993281,993282,513166,547123,513173,456531,456524,456500,336796,336772,336840,336826,336864
				,336802,336789,378109,378093,29049,540445,552424,552134,552417,552462,553179,552578,552196,552356,552387,552080
				,552400,552455,552271,552509,552097,552240,552448,552325,552349,553162,552332,552042,552073,552066,552639,552622
				,552257,552059,553322,552363,992248,992252,991087,991086,993340,993341,993339,541688,541664,541695,541671,538947
				,538909,992906,992907,992908,995145,995146,995147,995148,995150,995151,999653,1000477,999655,999654,999801,999628
				,994384,994385,994386,994383,995467,995469,995471,995473,1002058,1002059,1002060,1002051,1000794,1000795,1000796
				,995474,1000905,992478,992479,992261,995572,995573,995574,1001714,1001711,1001712,1001710,1001724,1004225,1004226
				,1004227,505529,505567,644075,673839,510592,505543,1001606,1001605,1001607,554602,554640,554633,554626,554619,554657
				,1002093,1002094,1002095,1002096,1002330,1001935,1001934,24211,40884,22071,22026,24099,22040,3896,2486,15400,63173
				,63197,13031,59039,676359,675925,481519,481434,481151,480642,480543)
			
			AND s.QTD_TOTAL_PRODUTO <> 0.00 
			AND CONVERT(DATE,s.DTA_SAIDA) BETWEEN CONVERT(DATE,@dataIni) AND CONVERT(DATE,@dataFim)
		GROUP BY
		s.COD_LOJA,
		DATEPART(YEAR,s.DTA_SAIDA),
		DATEPART(MONTH,s.DTA_SAIDA),
		--p.COD_SECAO ,
		--p.COD_GRUPO ,
		p.COD_PRODUTO,
		p.FLG_NAO_PIS_COFINS,
		l.[COD_TRIBUTACAO],
		l.[VAL_MARGEM],
		CASE WHEN tri.TIPO_TRIBUTACAO <= 2 THEN tri.val_icms*(1-val_reducao_base_calculo/100)/100 ELSE 0 END
		--tri.TIPO_TRIBUTACAO
	) AS MR
	GROUP BY
		COD_PRODUTO

-- -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- QUEBRA
-- -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	DECLARE @TAB_QUEBRA AS TABLE
	(
		COD_PRODUTO INT
		,VAL_CUSTO_REP NUMERIC(8,3)
		,QUEBRA_CUSTO NUMERIC(10,3)
		,QUEBRA_QTD NUMERIC(10,3)
	)
	
	INSERT INTO @TAB_QUEBRA	
	SELECT
		COD_PRODUTO
		,MAX(VAL_CUSTO_REP) AS  VAL_CUSTO_REP
		,SUM(QTD_AJUSTE*VAL_CUSTO_REP)
		,SUM(QTD_AJUSTE)
	FROM
		[192.168.0.6].zeus_rtg.dbo.TAB_AJUSTE_ESTOQUE
	WHERE 1 = 1
		and cod_loja not in (7)
		AND COD_AJUSTE IN (3,51,108,120,121,122,123,124,154)
		AND CONVERT(DATE,DTA_AJUSTE) BETWEEN CONVERT(DATE,@dataIni) AND CONVERT(DATE,@dataFim)
		AND COD_PRODUTO IN
			(27199,27496,27526,27533,27786,517324,517362,517331,993263,993262,993265,993264,993266,999698,999705,999701,999699
			,999700,994155,994153,994154,994158,994156,994157,994152,994151,748407,748421,748414,748438,44981, 993268 , 993270
			, 993272 ,993267, 993271, 993269 ,993273,993274,53822,21821,10832,10603,7245,4855,4725,8495,994146,994150,994149
			,994148,994145,994147,998446,998447,998448,998449,998450,998451,998452,998453,998454,998455,998456,998788,1001472
			,1001471,994149,994145,89661,1001931,1001932,1001933,89661,1004041,1004040,1004017,1001040,341110,593410,593472
			,750882,435185,593434,341196,750813,750790,593458,750844,750820,750837,594394,594387,594370,993277,993275,993278
			,993276,993279,993280,993281,993282,513166,547123,513173,456531,456524,456500,336796,336772,336840,336826,336864
			,336802,336789,378109,378093,29049,540445,552424,552134,552417,552462,553179,552578,552196,552356,552387,552080
			,552400,552455,552271,552509,552097,552240,552448,552325,552349,553162,552332,552042,552073,552066,552639,552622
			,552257,552059,553322,552363,992248,992252,991087,991086,993340,993341,993339,541688,541664,541695,541671,538947
			,538909,992906,992907,992908,995145,995146,995147,995148,995150,995151,999653,1000477,999655,999654,999801,999628
			,994384,994385,994386,994383,995467,995469,995471,995473,1002058,1002059,1002060,1002051,1000794,1000795,1000796
			,995474,1000905,992478,992479,992261,995572,995573,995574,1001714,1001711,1001712,1001710,1001724,1004225,1004226
			,1004227,505529,505567,644075,673839,510592,505543,1001606,1001605,1001607,554602,554640,554633,554626,554619,554657
			,1002093,1002094,1002095,1002096,1002330,1001935,1001934,24211,40884,22071,22026,24099,22040,3896,2486,15400,63173
			,63197,13031,59039,676359,675925,481519,481434,481151,480642,480543)
	GROUP BY
		COD_PRODUTO
		

-- -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- VENDA
-- -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	DECLARE @TAB_VENDA AS TABLE
	(
		COD_PRODUTO INT
		,VALOR_TOTAL NUMERIC(10,3)
		,QTDE_PRODUTO NUMERIC(10,3)
	)
	
	INSERT INTO @TAB_VENDA		
	SELECT
		COD_PRODUTO
		,SUM(VALOR_TOTAL) AS VALOR_TOTAL
		,SUM(QTDE_PRODUTO) AS QTDE_PRODUTO
	FROM
		BI.dbo.BI_VENDA_PRODUTO
	WHERE 1 = 1
		and cod_loja not in (7)
		AND COD_PRODUTO IN
			(27199,27496,27526,27533,27786,517324,517362,517331,993263,993262,993265,993264,993266,999698,999705,999701,999699
			,999700,994155,994153,994154,994158,994156,994157,994152,994151,748407,748421,748414,748438,44981, 993268 , 993270
			, 993272 ,993267, 993271, 993269 ,993273,993274,53822,21821,10832,10603,7245,4855,4725,8495,994146,994150,994149
			,994148,994145,994147,998446,998447,998448,998449,998450,998451,998452,998453,998454,998455,998456,998788,1001472
			,1001471,994149,994145,89661,1001931,1001932,1001933,89661,1004041,1004040,1004017,1001040,341110,593410,593472
			,750882,435185,593434,341196,750813,750790,593458,750844,750820,750837,594394,594387,594370,993277,993275,993278
			,993276,993279,993280,993281,993282,513166,547123,513173,456531,456524,456500,336796,336772,336840,336826,336864
			,336802,336789,378109,378093,29049,540445,552424,552134,552417,552462,553179,552578,552196,552356,552387,552080
			,552400,552455,552271,552509,552097,552240,552448,552325,552349,553162,552332,552042,552073,552066,552639,552622
			,552257,552059,553322,552363,992248,992252,991087,991086,993340,993341,993339,541688,541664,541695,541671,538947
			,538909,992906,992907,992908,995145,995146,995147,995148,995150,995151,999653,1000477,999655,999654,999801,999628
			,994384,994385,994386,994383,995467,995469,995471,995473,1002058,1002059,1002060,1002051,1000794,1000795,1000796
			,995474,1000905,992478,992479,992261,995572,995573,995574,1001714,1001711,1001712,1001710,1001724,1004225,1004226
			,1004227,505529,505567,644075,673839,510592,505543,1001606,1001605,1001607,554602,554640,554633,554626,554619,554657
			,1002093,1002094,1002095,1002096,1002330,1001935,1001934,24211,40884,22071,22026,24099,22040,3896,2486,15400,63173
			,63197,13031,59039,676359,675925,481519,481434,481151,480642,480543)
		AND CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,@dataIni) AND CONVERT(DATE,@dataFim)		
	GROUP BY
		COD_PRODUTO

-- -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- PRECOS
-- -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	DECLARE @TAB_PRECO AS TABLE
	(
		COD_PRODUTO INT
		,VLR_VENDA NUMERIC(10,3)
	)
	
	INSERT INTO @TAB_PRECO	
	SELECT 
		COD_PRODUTO
		,avg(VLR_VENDA) AS COUNT_VLR_VENDA
	FROM
		BI_LINHA_PRODUTOS AS LP
	WHERE 1 = 1
		and cod_loja not in (7)
		AND COD_PRODUTO IN
			(27199,27496,27526,27533,27786,517324,517362,517331,993263,993262,993265,993264,993266,999698,999705,999701,999699
			,999700,994155,994153,994154,994158,994156,994157,994152,994151,748407,748421,748414,748438,44981, 993268 , 993270
			, 993272 ,993267, 993271, 993269 ,993273,993274,53822,21821,10832,10603,7245,4855,4725,8495,994146,994150,994149
			,994148,994145,994147,998446,998447,998448,998449,998450,998451,998452,998453,998454,998455,998456,998788,1001472
			,1001471,994149,994145,89661,1001931,1001932,1001933,89661,1004041,1004040,1004017,1001040,341110,593410,593472
			,750882,435185,593434,341196,750813,750790,593458,750844,750820,750837,594394,594387,594370,993277,993275,993278
			,993276,993279,993280,993281,993282,513166,547123,513173,456531,456524,456500,336796,336772,336840,336826,336864
			,336802,336789,378109,378093,29049,540445,552424,552134,552417,552462,553179,552578,552196,552356,552387,552080
			,552400,552455,552271,552509,552097,552240,552448,552325,552349,553162,552332,552042,552073,552066,552639,552622
			,552257,552059,553322,552363,992248,992252,991087,991086,993340,993341,993339,541688,541664,541695,541671,538947
			,538909,992906,992907,992908,995145,995146,995147,995148,995150,995151,999653,1000477,999655,999654,999801,999628
			,994384,994385,994386,994383,995467,995469,995471,995473,1002058,1002059,1002060,1002051,1000794,1000795,1000796
			,995474,1000905,992478,992479,992261,995572,995573,995574,1001714,1001711,1001712,1001710,1001724,1004225,1004226
			,1004227,505529,505567,644075,673839,510592,505543,1001606,1001605,1001607,554602,554640,554633,554626,554619,554657
			,1002093,1002094,1002095,1002096,1002330,1001935,1001934,24211,40884,22071,22026,24099,22040,3896,2486,15400,63173
			,63197,13031,59039,676359,675925,481519,481434,481151,480642,480543) 
	GROUP BY
		COD_PRODUTO
		

-- -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- SELECT
-- -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
SELECT
	V.COD_PRODUTO
	,dbo.fn_FormataVlr_Excel(V.VALOR_TOTAL) as VALOR_TOTAL
	,dbo.fn_FormataVlr_Excel(V.QTDE_PRODUTO) as QTDE_PRODUTO
	,dbo.fn_FormataVlr_Excel(Q.VAL_CUSTO_REP) AS VAL_CUSTO_REP
	,dbo.fn_FormataVlr_Excel(M.MARGEM_REAL) as MARGEM_REAL
	,dbo.fn_FormataVlr_Excel(Q.QUEBRA_CUSTO * -1) as QUEBRA_CUSTO
	,dbo.fn_FormataVlr_Excel(Q.QUEBRA_QTD * -1) as QUEBRA_QTD
	,dbo.fn_FormataVlr_Excel(P.VLR_VENDA) as VLR_VENDA
FROM
	@TAB_VENDA AS V LEFT JOIN @TAB_MARGEM AS M ON (V.COD_PRODUTO = M.COD_PRODUTO)
		LEFT JOIN @TAB_QUEBRA AS Q ON (V.COD_PRODUTO = Q.COD_PRODUTO)
			LEFT JOIN @TAB_PRECO AS P ON (V.COD_PRODUTO = P.COD_PRODUTO)
		
