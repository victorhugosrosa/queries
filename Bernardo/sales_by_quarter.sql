-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
--
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	DECLARE @FORN_ORBIS AS TABLE
	(
		Q VARCHAR(15)
		,COD_FORNECEDOR INT
		,NO_FORNECEDOR VARCHAR(50)
		,VLR_VENDA NUMERIC(18,3)
	)

	INSERT INTO @FORN_ORBIS
	SELECT
		(CASE 
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20120701') AND CONVERT(DATE,'20120930') THEN 'P1 - 3Q 2012'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20121001') AND CONVERT(DATE,'20121231') THEN 'P2 - 4Q 2012'		
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20130101') AND CONVERT(DATE,'20130331') THEN 'P3 - 1Q 2013'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20130401') AND CONVERT(DATE,'20130630') THEN 'P4 - 2Q 2013'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20130701') AND CONVERT(DATE,'20130930') THEN 'P5 - 3Q 2013'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20131001') AND CONVERT(DATE,'20131231') THEN 'P6 - 4Q 2013'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20140101') AND CONVERT(DATE,'20140331') THEN 'P7 - 1Q 2014'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20140401') AND CONVERT(DATE,'20140630') THEN 'P8 - 2Q 2014'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20140701') AND CONVERT(DATE,'20140930') THEN 'P9 - 3Q 2014'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20141001') AND CONVERT(DATE,'20141031') THEN 'PX - Out2014'
		END) AS Q
		,CP.COD_FORNECEDOR
		,CF.DES_FANTASIA
		,SUM(VALOR_TOTAL) AS VLR_VENDA
	FROM 
		BI_VENDA_PRODUTO AS VP INNER JOIN BI_CAD_PRODUTO AS CP ON (VP.COD_PRODUTO = CP.COD_PRODUTO)
			INNER JOIN BI_CAD_FORNECEDOR AS CF ON (CP.COD_FORNECEDOR = CF.COD_FORNECEDOR)
	WHERE 1 = 1
		AND CP.COD_FORNECEDOR = 18055
		AND CP.COD_DEPARTAMENTO NOT IN (6)
		AND CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20120701') AND CONVERT(DATE,'20141031')
		AND CP.COD_PRODUTO IN (SELECT DISTINCT COD_PRODUTO FROM CADASTRO_CAD_PRODUTO_METADADOS AS M WHERE M.COD_METADADO = 4 AND VLR_METADADO = 1)
	GROUP BY
		(CASE 
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20120701') AND CONVERT(DATE,'20120930') THEN 'P1 - 3Q 2012'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20121001') AND CONVERT(DATE,'20121231') THEN 'P2 - 4Q 2012'		
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20130101') AND CONVERT(DATE,'20130331') THEN 'P3 - 1Q 2013'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20130401') AND CONVERT(DATE,'20130630') THEN 'P4 - 2Q 2013'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20130701') AND CONVERT(DATE,'20130930') THEN 'P5 - 3Q 2013'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20131001') AND CONVERT(DATE,'20131231') THEN 'P6 - 4Q 2013'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20140101') AND CONVERT(DATE,'20140331') THEN 'P7 - 1Q 2014'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20140401') AND CONVERT(DATE,'20140630') THEN 'P8 - 2Q 2014'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20140701') AND CONVERT(DATE,'20140930') THEN 'P9 - 3Q 2014'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20141001') AND CONVERT(DATE,'20141031') THEN 'PX - Out2014'
		END)
		,CP.COD_FORNECEDOR
		,CF.DES_FANTASIA
		
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
--
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	DECLARE @FORN_TOPS AS TABLE
	(
		Q VARCHAR(15)
		,COD_FORNECEDOR INT
		,NO_FORNECEDOR VARCHAR(50)
		,VLR_VENDA NUMERIC(18,3)
	)

	INSERT INTO @FORN_TOPS
	SELECT --TOP 99
		(CASE 
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20120701') AND CONVERT(DATE,'20120930') THEN 'P1 - 3Q 2012'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20121001') AND CONVERT(DATE,'20121231') THEN 'P2 - 4Q 2012'		
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20130101') AND CONVERT(DATE,'20130331') THEN 'P3 - 1Q 2013'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20130401') AND CONVERT(DATE,'20130630') THEN 'P4 - 2Q 2013'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20130701') AND CONVERT(DATE,'20130930') THEN 'P5 - 3Q 2013'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20131001') AND CONVERT(DATE,'20131231') THEN 'P6 - 4Q 2013'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20140101') AND CONVERT(DATE,'20140331') THEN 'P7 - 1Q 2014'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20140401') AND CONVERT(DATE,'20140630') THEN 'P8 - 2Q 2014'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20140701') AND CONVERT(DATE,'20140930') THEN 'P9 - 3Q 2014'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20141001') AND CONVERT(DATE,'20141031') THEN 'PX - Out2014'
		END) AS Q
		,CP.COD_FORNECEDOR
		,CF.DES_FANTASIA
		,SUM(VALOR_TOTAL) AS VLR_VENDA
	FROM 
		BI_VENDA_PRODUTO AS VP INNER JOIN BI_CAD_PRODUTO AS CP ON (VP.COD_PRODUTO = CP.COD_PRODUTO)
			INNER JOIN BI_CAD_FORNECEDOR AS CF ON (CP.COD_FORNECEDOR = CF.COD_FORNECEDOR)
	WHERE 1 = 1
		AND CP.COD_FORNECEDOR <> 18055
		AND CP.COD_DEPARTAMENTO NOT IN (6)
		AND CONVERT(DATE,DATA) BETWEEN CONVERT(DATE,'20120701') AND CONVERT(DATE,'20141031')
	GROUP BY
		(CASE 
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20120701') AND CONVERT(DATE,'20120930') THEN 'P1 - 3Q 2012'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20121001') AND CONVERT(DATE,'20121231') THEN 'P2 - 4Q 2012'		
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20130101') AND CONVERT(DATE,'20130331') THEN 'P3 - 1Q 2013'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20130401') AND CONVERT(DATE,'20130630') THEN 'P4 - 2Q 2013'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20130701') AND CONVERT(DATE,'20130930') THEN 'P5 - 3Q 2013'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20131001') AND CONVERT(DATE,'20131231') THEN 'P6 - 4Q 2013'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20140101') AND CONVERT(DATE,'20140331') THEN 'P7 - 1Q 2014'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20140401') AND CONVERT(DATE,'20140630') THEN 'P8 - 2Q 2014'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20140701') AND CONVERT(DATE,'20140930') THEN 'P9 - 3Q 2014'
			WHEN CONVERT(DATE,VP.DATA) BETWEEN CONVERT(DATE,'20141001') AND CONVERT(DATE,'20141031') THEN 'PX - Out2014'
		END)
		,CP.COD_FORNECEDOR
		,CF.DES_FANTASIA
	
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
--
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	DECLARE @RANKING_FORN AS TABLE
	(
		Q VARCHAR(15)
		,COD_FORNECEDOR INT
		,NO_FORNECEDOR VARCHAR(50)
		,VLR_VENDA NUMERIC(18,3)
	)

	INSERT INTO @RANKING_FORN
	SELECT
		Q
		,COD_FORNECEDOR
		,NO_FORNECEDOR
		,VLR_VENDA
	FROM
		@FORN_ORBIS
		
	INSERT INTO @RANKING_FORN
	SELECT
		Q
		,COD_FORNECEDOR
		,NO_FORNECEDOR
		,VLR_VENDA
	FROM
		@FORN_TOPS

	-- ##############################################################
	-- 
	-- ##############################################################
	SELECT
		Q
		,COD_FORNECEDOR
		,NO_FORNECEDOR
		,BI.dbo.fn_FormataVlr_Excel(VLR_VENDA) AS VENDA
	FROM
		@RANKING_FORN
	ORDER BY
		Q
		,VLR_VENDA DESC