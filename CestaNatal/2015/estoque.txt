
SELECT 
	ESTOQUE.[IDPRODUTO_ESTOQUE]
	,PRODUTO.[IDPRODUTO] AS IDPRODUTO
	,ESTOQUE.[IDLOJA]
	,ESTOQUE.[QTD_ESTOQUE_FISICO]
	,ESTOQUE.[QTD_DISPONIVEL]
	,ESTOQUE.[DATA_CRIACAO] AS [DATA_CRIACAO_ESTOQUE]
	,ESTOQUE.[DATA_ATUALIZACAO]
	,ESTOQUE.[STATUS]
	,ESTOQUE.[QTD_PRODUZIDA]
	,ESTOQUE.[QTD_TRANSFERIDA]
	,ESTOQUE.[DATA_PRODUCAO]
	,ESTOQUE.[META]	
	,produto.DESCRICAO
	,(
	SELECT 
	  SUM(QUANTIDADE)
	FROM [dbCestaNatal].[dbo].[VW_QLIK_PEDIDO] AS TPED INNER JOIN [dbCestaNatal].[dbo].[VW_QLIK_PEDIDO_ITEM] AS TPED_ITEM ON (TPED.IDPEDIDO = TPED_ITEM.IDPEDIDO)
	WHERE 1 = 1
		AND TPED.[IDSTATUS_PED] = 4
		AND cast(ESTOQUE.IDPRODUTO_SKU as double precision) = cast(TPED_ITEM.IDPRODUTO as double precision)
	) AS [QTD_COMPROMETIDO]
FROM
	[dbCestaNatal].[dbo].[SMCB_PRODUTO_ESTOQUE] as ESTOQUE 
	left join [dbCestaNatal].[dbo].[SMCB_PRODUTO_SKU] as PRODUTO on (ESTOQUE.IDPRODUTO_SKU = PRODUTO.IDPRODUTO_SKU)	
where 1 = 1
	AND ESTOQUE.[DATA_PRODUCAO] > getdate() - 90
	
