declare @offer as table
(
[COD_LOJA] int
,[COD_PRODUTO] int
,[DTA_INI] date
,[DTA_FIM] date
,VC_MARCHE numeric(8,3)
,DESCR_VC_MARCHE VARCHAR(50)
)

insert into @offer
SELECT [COD_LOJA]
  ,[COD_PRODUTO]
  ,[DTA_INI]
  ,[DTA_FIM]
  ,[VALOR] as VC_MARCHE
  ,DESCRICAO as DESCR_VC_MARCHE
FROM [BI].[dbo].[BI_PRECO_VENDA]
where 1=1 
and TIPO=2
and DTA_INI<=CONVERT(date,getdate())
and DTA_FIM>=CONVERT(date,getdate()+30)

SELECT  pv.[COD_LOJA]
      ,cp.[COD_PRODUTO]
      ,CP.DESCRICAO
      ,[VLR_VENDA] as VENDA
      ,[VLR_OFERTA] AS OFERTA
      ,bpv.VC_MARCHE 
      ,po.[DTA_INI] AS DTA_INI_PO
      ,po.[DTA_FIM] AS DTA_FIM_PO
      ,po.[Descricao] AS DESCRICAO_PO
      ,bpv.DESCR_VC_MARCHE 
      ,bpv.[DTA_INI] AS DTA_INI_VM
      ,bpv.[DTA_FIM] AS DTA_FIM_VM
      ,CP.COD_PRODUTO_SIMILAR 
      ,AX_PROD.PROIBIDO_COMPRA
      ,(CASE
			WHEN po.[Descricao] LIKE '%LISTA COMBATE%' AND po.[DTA_FIM] IS NOT NULL THEN DATEADD(DAY,180,po.[DTA_FIM]) --NORMAL
			WHEN po.[Descricao] LIKE '%VOCÊ MARCHE%' AND bpv.[DTA_FIM] IS NOT NULL THEN DATEADD(DAY,30,bpv.[DTA_FIM])
			WHEN po.[Descricao] LIKE '%OFERTA NEGOCIACAO%' AND po.[DTA_FIM] IS NOT NULL THEN DATEADD(DAY,60,po.[DTA_FIM])
      END) AS X
  FROM [BI].[dbo].[BI_CAD_PRODUTO] AS CP
  left join [BI].[dbo].[VW_PRECOS_VENDA_ATIVOS] as pv ON (pv.COD_PRODUTO = CP.COD_PRODUTO)  
   left join dbo.VW_PRECOS_OFERTA_ATIVOS as po
  on 1=1
  and pv.COD_LOJA=po.COD_LOJA
  and pv.COD_PRODUTO=po.COD_PRODUTO
  left join  @offer as bpv
  on 1=1 
    and pv.COD_LOJA=bpv.COD_LOJA
  and pv.COD_PRODUTO=bpv.COD_PRODUTO
  
  LEFT JOIN AX2009_INTEGRACAO.dbo.vw_MARCHE_PRODUTO_SITUACAO AS AX_PROD ON (CP.COD_PRODUTO = AX_PROD.COD_PRODUTO AND pv.[COD_LOJA]=AX_PROD.COD_LOJA)
  
  where 1=1
and cp.cod_produto in
(
429108,
429092,
429085,
556545,
1000964,
577021,
512435,
512671,
512589,
220095,
577014,
512732,
512701,
512664,
512572,
512541,
558822,
558839,
558815,
558808,
512534,
991716,
991714,
991715,
991717,
991718,
991719,
991713,
991721,
992692,
992693,
992691,
1000965,
1000966,
1000967,
992606,
992604,
1002485,
1002486,
1002041,
1002042,
1002043,
1002044,
990814,
990821,
990823,
990816,
990815,
990818,
990819,
990825,
993610,
990813,
990820,
990824,
990822,
990812,
561556,
561563,
561600,
561587,
561617,
561594,
561549,
561624,
561570,
1001341,
1001342,
1001343,
992799,
992801,
992802,
992798,
992800,
998483,
998484,
998485,
998486,
998487,
1002406,
1002407,
1002408,
1002409,
1002410,
1002411,
1002412,
1002413,
1002414,
1002415,
1002416,
1002418,
1002419,
1002420,
1002421,
1002422,
1002405,
1002475,
1002478,
1002479,
1002480,
1002481,
1002482,
1002483,
1002543,
1002545,
1002544,
1002546,
1002547,
1002568,
983464,
1002784,
1002785,
1002786,
1002787,
1002788,
1002789,
1002790,
1002791,
1002781,
1002772,
1002773,
1002774,
1002775,
1002776,
1002777,
1002778,
1002500,
10252,
995057,
1001573,
995605,
995606,
995607,
1000052,
520300,
1001328,
1001329,
1001330,
1001332,
1001333,
1001334,
1001335,
1001336,
1001337,
1001338,
1001340,
1001751,
1001750,
1001752,
1001782,
1001783,
1001784,
1001785,
1001764,
1001745,
1001746,
1001747,
1001748,
1001749,
1001765,
1001766,
1001767,
1001768,
1001769,
1001770,
1001789,
1001790,
1001791,
1001792,
1001793,
1001794,
1001795,
1001796,
1001797,
1001798,
1001807,
1001808,
1001809,
1001810,
1001799,
1001800,
1001801,
1001802,
1001803,
1001804,
1001805,
1001806,
1001786,
1001787,
1001788,
1001816,
1001817,
1001818,
1001819,
1001820,
1001821,
1001822,
1001821,
1001811,
1001812,
1001813,
1001814,
1001815,
1001824,
1001825,
1001826,
1001827,
1001828,
1001829,
1001830,
1001831,
1001832,
1001833,
1001834,
1001835,
1001836,
1001837,
1001838,
1001839,
1001840,
1001841,
1001853,
1001854,
1001855,
1001856,
1001857,
1001858,
1001859,
1001860,
1001861,
1001862,
1001863,
1001864,
1001865,
1001866,
1001867,
1001868,
1001869,
1001870,
1001871,
1001872,
1001873,
1001874,
1001875,
1001876,
1001877,
994732,
994733,
994734,
994735,
994736,
994737,
994738,
994739,
994740,
994741,
994742,
994743,
994744,
994745,
994746,
994747,
994748,
994749,
994750,
994765,
994766,
994767,
994768,
994769,
994770,
994771,
994772,
994773,
994774,
994775,
994776,
994777,
994778,
994779,
994780,
994781,
994782,
994783,
994784,
994785,
994786,
994787,
994788,
994789,
994790,
994791,
994792,
994793,
994794,
994795,
994796,
994797,
1000126,
1000127,
1000128,
1000116,
1000117,
1000090,
1000092,
1000091,
1000118,
1000120,
1000119,
1000093,
1000107,
1000106,
1000108,
1000121,
1000125,
1000123,
1000124,
1000122,
1000111,
1000100,
1000112,
1000103,
1000110,
1000109,
1000115,
1000101,
1000102,
1000105,
1000104,
1000113,
1000114,
1000250,
1000251,
1000252,
1000253,
1000254,
1001397,
1001398,
1001399,
1001400,
1001401,
1001402,
1001403,
1001357,
1001364,
1001366,
1001367,
1001368,
1001369,
1001370,
1001371,
1001372,
1001390,
1001391,
1001392,
1001373,
1001358,
1001359,
1001374,
1001375,
1001376,
1001361,
1001360,
1001362,
292900,
1001365,
1001363,
1001377,
1001378,
1001381,
1001382,
1001388,
1001383,
1001384,
1001385,
1001386,
1001387,
1001393,
1001396,
1001394,
1001395,
1001380,
1001379,
1002213,
1002214,
1002215,
1002216,
1002176,
1002177,
1002178,
1002179,
994714,
1002180,
994715,
994724,
994725,
1002181,
1002182,
244305,
1002183,
1002184,
1002185,
1002186,
1002187,
1002188,
1002189,
1002190,
1002191,
1002192,
1002193,
1002194,
1002195,
1002196,
1002197,
1002198,
1002199,
1002217,
1002218,
1002219,
1002220,
1002221,
1002222,
1002223,
1002224,
1002225,
1002226,
1002227,
1002228,
1002229,
1002230,
1002231,
1002232,
1002233,
1002234,
1002235,
1002236,
1002468,
1002470,
1002472,
1002473,
1002487,
1002476,
1002477,
1002474,
1002445,
1002446,
1002447,
1002448,
1002449,
1002450,
1002451,
1002452,
1002453,
1002454,
1002455,
1002456,
1002457,
1002458,
1002459,
1002460,
1002461,
1002462,
1002463,
1002438,
1002439,
1002440,
1002441,
1002442,
1002443,
1002433,
1002434,
1002435,
1002436,
1002437,
1002444,
1002655,
1002660,
1002656,
1002657,
1002658,
1002659,
1002661,
1002662,
1002663,
1002664,
1002665,
1002652,
1002653,
1002654,
1002646,
1002647,
1002648,
1002649,
1002667,
1002668,
1002669,
1002670,
1002680,
1002681,
1002682,
1002683,
1002684,
1002685,
1002686,
1002687,
1002688,
1002689,
1002671,
1002672,
1002673,
1002674,
1002675,
1002676,
1002677
)
--ANd (pv.cod_loja in(@cod_loja) OR pv.cod_loja IS NULL)
AND (CONVERT(DATE,po.[DTA_FIM]) >= CONVERT(DATE,GETDATE()) OR CONVERT(DATE,bpv.[DTA_FIM]) >= CONVERT(DATE,GETDATE()))
order by CP.DESCRICAO